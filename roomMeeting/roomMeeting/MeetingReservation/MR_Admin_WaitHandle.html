<!DOCTYPE html>
<html lang="en">
	<head>
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<meta charset="utf-8" />
		<title>会议室预定后台管理-会议室待审核</title> 
		<meta name="description" content="Common Buttons &amp; Icons" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0" />
		<!-- bootstrap & fontawesome -->
		<link rel="stylesheet" href="../assets/css/bootstrap.min.css" />
		<link rel="stylesheet" href="../assets/css/font-awesome.min.css" />
		<!-- page specific plugin styles -->
		<!-- text fonts -->
		<link rel="stylesheet" href="../assets/css/ace-fonts.css" />
		<!-- ace styles -->
		<link rel="stylesheet" href="../assets/css/ace.min.css" />
		<!--[if lte IE 9]>
			<link rel="stylesheet" href="../assets/css/ace-part2.min.css" />
		<![endif]-->
		<link rel="stylesheet" href="../assets/css/ace-skins.min.css" />
		<link rel="stylesheet" href="../assets/css/ace-rtl.min.css" />
		<!--[if lte IE 9]>
		  <link rel="stylesheet" href="../assets/css/ace-ie.min.css" />
		<![endif]-->
		<!-- inline styles related to this page -->
		<!-- ace settings handler -->
		<script src="../assets/js/ace-extra.min.js"></script>
		<!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->

		<!--[if lte IE 8]>
		<script src="../assets/js/html5shiv.js"></script>
		<script src="../assets/js/respond.min.js"></script>
		<![endif]-->
		<script src='../assets/js/jquery.min.js'></script>
		<script src="../layer/layer.min.js"></script>

		<script src="../myjs/backupNew.js"></script>
		<script src="../myjs/lexus.js"></script>
		
		<!-- ace settings handler -->
		<script src="../assets/js/ace-extra.min.js"></script>
		<script src="../assets/js/bootstrap-tag.min.js"></script>

		<!-- 加载自定义样式 -->
    	<link rel="stylesheet" href="css/custom.css">
    	<style type="text/css">
			.table>thead>tr>th, .table>tbody>tr>th, .table>tfoot>tr>th, .table>thead>tr>td, .table>tbody>tr>td, .table>tfoot>tr>td{
				vertical-align:middle;text-align:center;
			}
			.table>tbody>tr>td>p, .table>tbody>tr>th{
				margin-bottom:0px;
			}
			.btn-success{
				background-color: #629b58 !important;
				border-color: #629b58
			}
			.btn-success:focus {
				background-color: #629b58 !important;
				border-color: #87b87f
			}
			.table>tbody>tr{
				cursor:pointer;
			}
			.widget-color-blue2>.widget-header {
				background: #2577e3;
				border-color: #2577e3;
			}
    	</style>
	</head>

	<body class="no-skin">
		<div class="main-container" id="main-container">
			<!-- /section:basics/sidebar -->
			<script type="text/javascript">
				try{ace.settings.check('main-container' , 'fixed')}catch(e){}
			</script>
			<div class="main-content">
				<div class="breadcrumbs" id="breadcrumbs" style="background:#2577e3;">
					<script type="text/javascript">
						try {
							ace.settings.check('breadcrumbs', 'fixed')
						} catch(e) {}
					</script>
					<ul class="breadcrumb">
						<li>
							<i class="ace-icon fa fa-home home-icon white">
							</i>
							<a href="#" id="qiyemenghu" onclick="MHUrl()" class="white">企业信息门户</a>
						</li>
						<li>
							<a href="#" class="white">
								会议室待审核
							</a>
						</li>
					</ul>
					<!-- /.breadcrumb -->
					<!-- /section:basics/content.searchbox -->
				</div>
				<div class="page-content">
					<div class="page-content-area">
						<div class="page-header">
							<h1 style="font-family:Microsoft YaHei ! important;">
                                <a href="#">会议室待审核</a>
							</h1>
						</div>

						<div class="row">
							<div class="col-xs-12">
								<div class="tab-pane fade in active">
						            <div class="row">
										<div class="col-xs-12">
											<div class="widget-box widget-color-blue2">
												<div class="widget-header widget-header-blue widget-header-flat">
													<h5 class="widget-title bigger lighter">
														<i class="ace-icon fa fa-table"></i>
														会议室待审核列表
													</h5>
												</div>
												<div id="sample-table-2_wrapper" class="dataTables_wrapper form-inline no-footer">
													<div class="row" style="padding-top:0px;padding-bottom:0px;">
														<table id="sample-table-2" class="table table-striped table-bordered table-hover"
														style="margin-bottom:0px;">
															<thead>
																<tr>	
																	<th width="15%">会议时间</th>
																	<th width="14%">会议室名称</th>
																	<th width="20%">预约人</th>
																	<th width="12%">会议类型</th>
																	<th width="12%">会议主题</th>
																	<th width="15%">申请时间</th>
																	<th width="12%">操作</th>
																</tr>
															</thead>
															<tbody id="Audit"></tbody>
														</table>
													</div>
													<div class="row" style="border-left:1px solid #e0e0e0;border-right:1px solid #e0e0e0;padding-top:17px;">
														<div class="col-xs-6">
															<div class="dataTables_length" id="sample-table-2_length">
																<label style="margin-top:4px;">
                                                                    每页显示
                                                                    <select name="sample-table-2_length" aria-controls="sample-table-2" class="form-control input-sm sample-table-2_length" onchange="changeNum();">
                                                                        <option value="10" id="select_10">
                                                                            10
                                                                        </option>
                                                                        <option value="25" id="select_25">
                                                                            25
                                                                        </option>
                                                                        <option value="50" id="select_50">
                                                                            50
                                                                        </option>
                                                                        <option value="100" id="select_100">
                                                                            100
                                                                        </option>
                                                                    </select>
                                                                    条
                                                                </label>
															</div>
														</div>
														<div class="col-xs-6">
															<div class="dataTables_paginate paging_simple_numbers" id="sample-table-2_paginate">
																<ul class="pagination">
                                                                    <table cellspacing="0" cellpadding="0" border="0" style="table-layout:auto;" class="ui-pg-table">
                                                                        <tbody>
                                                                        <tr>
                                                                            <td id="first-pager" class="ui-pg-button ui-corner-all">
                                                                                <span class="ui-icon ace-icon fa fa-angle-double-left bigger-140"onclick="firstPages()"></span>
                                                                            </td>
                                                                            <td id="prev-pager" class="ui-pg-button ui-corner-all">
                                                                                <span class="ui-icon ace-icon fa fa-angle-left bigger-140" onclick="prevPage()"></span>
                                                                            </td>
                                                                            <td dir="ltr" style="line-height: inherit;">
                                                                                <span style="margin-top: 3px; float: left; display: inline-block;">&nbsp;第</span>
                                                                                <input id="current-page" style="height: 25px; line-height: 12px;" onchange="changePage(this.value)" type="text" size="1">
                                                                                <span style="margin-top: 3px; float: right; display: inline-block;">页&nbsp;</span>
                                                                            </td>
                                                                            <td id="next-pager" class="ui-pg-button ui-corner-all">
                                                                                <span class="ui-icon ace-icon fa fa-angle-right bigger-140" onclick="nextPages()"></span>
                                                                            </td>
                                                                            <td id="last-pager" class="ui-pg-button ui-corner-all">
                                                                                <span class="ui-icon ace-icon fa fa-angle-double-right bigger-140" onclick="lastPage()"></span>
                                                                            </td>
                                                                            <td dir="ltr">
                                                                                &nbsp;共&nbsp;<span id="page-count"></span>&nbsp;页
                                                                            </td>
                                                                        </tr>
                                                                        </tbody>
                                                                    </table>
                                                                </ul>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
						        </div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		



		<!-- basic scripts -->
		<!--[if !IE]> -->
		<script type="text/javascript">
			window.jQuery || document.write("<script src='../assets/js/jquery.min.js'>"+"<"+"/script>");
		</script>
		<!-- <![endif]-->
		<!--[if IE]>
		<script type="text/javascript">
		 window.jQuery || document.write("<script src='../assets/js/jquery1x.min.js'>"+"<"+"/script>");
		</script>
		<![endif]-->
		<script type="text/javascript">
			if('ontouchstart' in document.documentElement) document.write("<script src='../assets/js/jquery.mobile.custom.min.js'>"+"<"+"/script>");
		</script>
		<script src="../assets/js/bootstrap.min.js"></script>
		<!-- page specific plugin scripts -->
		<!-- ace scripts -->
		<script src="../assets/js/ace-elements.min.js"></script>
		<script src="../assets/js/ace.min.js"></script>
		<script type="text/javascript"> ace.vars['base'] = '.'; </script>
		<script src="../assets/js/ace/elements.onpage-help.js"></script>
		<script src="../assets/js/jquery.gritter.min.js"></script>
		<!-- inline scripts related to this page -->
		<script type="text/javascript">
			//待审批列表弹出详情
			function ToWaitHandleDetails(obj){
				window.open('MR_Admin_WaitHandle_Details.html?WaitHandle=' + obj);
				// alert("待审批列表弹出详情");
			}
			
			//初始化页面数据
            $.ajaxSetup({
                contentType: 'application/json',
                async:false,
                error:function(){
                    var unique_id = $.gritter.add({
                        title: '系统警告信息提示',
                        text: ''+errMsg1+'<p style="padding-top:14px;"><span class="col-sm-6"></span><span class="col-sm-6" style="text-align:right;"><button class="btn btn-xs btn-success" onclick="CloseGritter(this);WindowClose();"><i class="ace-icon fa fa-check"></i>确定</button></span></p>',
                        sticky: true,
                        time: '',
                        class_name: 'gritter-info gritter-center'
                    });
                },
                timeout:timeout
             });

            // 获取cookie
            function getCookie() {
                var localCookie = document.cookie;
                var cookie_user = '';
                if(localCookie.length > 0 && localCookie.indexOf('userid')>-1){
                    localCookie = localCookie.split(';');
                    for(var lc in localCookie){
                        if(localCookie[lc].indexOf('userid=')>-1){
                            cookie_user = localCookie[lc];
                            break;
                        }
                    }
                    if(cookie_user == ''){
                        var unique_id = $.gritter.add({
                            title: '系统登录错误提示',
                            text: '无法获取信息，请重新登录<p style="padding-top:14px;"><span class="col-sm-6"></span><span class="col-sm-6" style="text-align:right;"><button class="btn btn-xs btn-success" onclick="CloseGritter(this);WindowClose();"><i class="ace-icon fa fa-check"></i>确定<tton></span></p>',
                            sticky: true,
                            time: '',
                            class_name: 'gritter-info gritter-center'
                        });
                    }else{
                        cookie_user = trim(cookie_user).substring(7);
                        localStorage.removeItem('pernrBase');
                        localStorage.setItem('pernrBase',cookie_user);
                    }
                }else{
                    var unique_id = $.gritter.add({
                        title: '系统登录错误提示',
                        text: '无法获取信息，请重新登录<p style="padding-top:14px;"><span class="col-sm-6"></span><span class="col-sm-6" style="text-align:right;"><button class="btn btn-xs btn-success" onclick="CloseGritter(this);WindowClose();"><i class="ace-icon fa fa-check"></i>确定<tton></span></p>',
                        sticky: true,
                        time: '',
                        class_name: 'gritter-info gritter-center'
                    });
                }
            }

			jQuery(function($) {
                getCookie();
				//页面初始化
				var pageNum = 1;
                var num = 10;
                searchMeetingRoomList(localStorage["pernrBase"],num,pageNum);
                
                //待审批列表同意操作
                $(".toWaitHandleAgreed").on("click",function(event){
                    //var id=$(this).attr("rel");
                    
                    var meetRoomId = $(this).next().val();
                    var startTime = getTimeToUnit($(this).parent().parent().find('.startTime').html());
                    var endTime = getTimeToUnit($(this).parent().parent().find('.endTime').html());
                    var scheduleId = $(this).next().next().val();
                    $.layer({
                        shade: [0],
                        area: ['auto','auto'],
                        dialog: {
                            msg: '您确认同意吗？',
                            btns: 2,                    
                            type: 4,
                            btn: ['是','否'],
                            yes: function(){
                                //判断申请时间段是否冲突
                                isPassed(meetRoomId, startTime, endTime, scheduleId);
                            }, no: function(){
                            }
                        }
                    });
                    
                   
                    event.stopPropagation();    //  阻止事件冒泡
                });
			});
			
			function isPassed(meetRoomId, startTime, endTime, scheduleId)
            {
                var paramJSon = {
                  'meetingRoomId' : meetRoomId,
                  'startTime':startTime,
                  'endTime':endTime
                };
                $.post("/meet/isPassed",JSON.stringify(paramJSon),function(data){
                //data=jQuery.parseJSON(data)
                    if(data.code==0){
                        var paramJSon = {
                            'startTime': startTime,
                            'endTime': endTime,
                            'meetingRoomId': meetRoomId
                        };
                        $.post("/meet/validateClearOverTime",JSON.stringify(paramJSon),function(info){
                            if(info.status == 0) {
                                isFrozen(meetRoomId, startTime, endTime, scheduleId);
                            }else {
                                $.layer({
                                    shade: [0],
                                    area: ['auto','auto'],
                                    dialog: {
                                        msg: '申请时间段与清场时间冲突，是否强制同意？',
                                        btns: 2,
                                        type: 4,
                                        btn: ['是','否'],
                                        yes: function(){
                                            //判断申请时间段是否冲突
                                            isFrozen(meetRoomId, startTime, endTime, scheduleId);
                                        }, no: function(){
                                        }
                                    }
                                });
                            }
                        });
                    }else{
                        layer.msg(data.msg,2,-1);
                    }
                });                
            }
            
            function isFrozen(meetRoomId, startTime, endTime, scheduleId)
            {
                var paramJSon = {
                  'meetRoomId' : meetRoomId,
                  'startTime':startTime,
                  'endTime':endTime
                };
                $.post("/meet/isFrozen",JSON.stringify(paramJSon),function(data){
                //data=jQuery.parseJSON(data)
                    if(data.isFrozen==0){
                        agreeAction(meetRoomId, scheduleId);
                    }else{
                        layer.msg('该会议室在申请时间段被冻结', 1, -1);
                    }
                });
            }
            
            function agreeAction(meetRoomId, scheduleId) {  
                var userName=selectUser();
                var paramJSon = {
                    'scheduleId':scheduleId,
                    'state':2,
                    'meetRoomId':meetRoomId,
                    'comments':'',
                    'servicePersonal':[],
                    'technicist':[],
                    'userId':localStorage["pernrBase"],
                    'userName':userName,
                };
                $.post("/meet/shenpiHuiyishi",JSON.stringify(paramJSon),function(data){
                //data=jQuery.parseJSON(data)
                    if(data.status==0){
                        layer.msg('操作成功', 1, 1);
                        location.reload();
                    }else{
                        layer.msg(data.msg, 1, -1);
                    }
                    
                });
            }

            //更换显示页数
            function changeNum() {
                var pageNum = 1;
                var pageSize = $(".sample-table-2_length").val();
                searchMeetingRoomList(localStorage["pernrBase"], pageSize, pageNum);
            }

            // 首页
            function firstPages() {
                var pageSize = $(".sample-table-2_length").val();
                var pageNum = 1;
                $("#current-page").val(1);
                searchMeetingRoomList(localStorage["pernrBase"],pageSize,pageNum);
            }

            // 尾页
            function lastPage() {
                var pageSize = $(".sample-table-2_length").val();
                var pageNum = $("#page-count").html();
                searchMeetingRoomList(localStorage["pernrBase"],pageSize,pageNum);
            }

            // 上一页
            function prevPage() {
                var pageSize = $(".sample-table-2_length").val();
                var currentPage = $("#current-page").val();
                var pageNum = currentPage - 1;
                if(pageNum < 0) {
                    pageNum = 1;
                }
                searchMeetingRoomList(localStorage["pernrBase"],pageSize,pageNum);
            }

            //下一页
            function nextPages(){
                var pageSize = $(".sample-table-2_length").val();
                var totalPages = $("#page-count").html();
                var currentPage = $("#current-page").val();
                var pageNum = parseInt(currentPage) + 1;
                if(pageNum > totalPages) {
                    pageNum = totalPages;
                }
                searchMeetingRoomList(localStorage["pernrBase"],pageSize,pageNum);
            }

            // 检查 首页尾页上一页下一页是否可用
            function checkDisable() {
                var pageNum = $("#current-page").val();
                var totalpages = $("#page-count").html();

                $("#first-pager").removeClass("ui-state-disabled");
                $("#prev-pager").removeClass("ui-state-disabled");
                $("#next-pager").removeClass("ui-state-disabled");
                $("#last-pager").removeClass("ui-state-disabled");
                if(pageNum <= 1) {
                    $("#first-pager").addClass("ui-state-disabled");
                    $("#prev-pager").addClass("ui-state-disabled");
                }
                if (pageNum == totalpages) {
                    $("#next-pager").addClass("ui-state-disabled");
                    $("#last-pager").addClass("ui-state-disabled");
                }
            }

            // 跳转指定页面
            function changePage(pageNum) {
                var totalpages = $("#page-count").html();
                pageNum = parseInt(pageNum);

                if(isNaN(pageNum) || pageNum < 1) {
                    pageNum = 1;
                }
                if(pageNum > totalpages) {
                    pageNum = totalpages;
                }
                var pageSize = $(".sample-table-2_length").val();
                searchMeetingRoomList(localStorage["pernrBase"],pageSize,pageNum);
            }

            //调去查询查询接口
            function searchMeetingRoomList(userId,pageSize,pageNum){
                var paramJSon = {
                    "userId":localStorage["pernrBase"],
                    "state":'0',
                    "pageSize":Number(pageSize),
                    "pageNum":Number(pageNum)
                }
                $.post("/meet/examine",JSON.stringify(paramJSon),function(data){

                    var MeetingRoomList = "";
                    if(data.status == '0'){
                        $.each(data.data,function(n,value) {   
                           var startTime=formatDate(value['startTime']);
                           var endTime=formatDate(value['endTime']);
                           var createTime=formatDate(value['createTime']);
                           var state='';
                           if(value['state']==2 || value['state']==5){
                                state='通过';
                           }else if(value['state']==3){
                                state='驳回';
                           }
                           MeetingRoomList +='<tr onclick="ToWaitHandleDetails('+"'"+value['_id']+"'"+')">'
                                                +'<td title="" style="padding:12px 8px;">'
                                                    +'<p>'
                                                        +'<span class="startTime">'
                                                            +startTime
                                                        +'</span>'
                                                    +'</p>'
                                                    +'<p style="padding:2px 0;"><i class="fa fa-arrow-down" style="font-size:14px;color:#6fa836"></i></p>'
                                                    +'<p>'
                                                        +'<span class="endTime">'
                                                            +endTime
                                                        +'</span>'
                                                    +'</p>'
                                                +'</td>'
                                                +'<td title="">'
                                                    +value['name']
                                                +'</td>'
                                                +'<td title="">'
                                                    +value['userName']
                                                +'</td>'
                                                +'<td title="">'
                                                    +(value['needApply']== 1 ? '需要审批' : '不需要审批')
                                                +'</td>'
                                                +'<td title="">'
                                                    +value['topic']
                                                +'</td>'
                                                +'<td title="">'
                                                    +'<span>'
                                                        +createTime
                                                    +'</span>'
                                                +'</td>'
                                                +'<td title="">'
                                                    +'<button class="btn btn-success toWaitHandleAgreed">'
                                                     +'<i class="ace-icon fa fa-check"></i>同意 </button>'
                                                     +'<input type="hidden" name="meetRoomIdscheduleId" value="' + value['meetRoom'] + '" />'
                                                     +'<input type="hidden" name="scheduleId" value="' + value['_id'] + '" />'
                                                +'</td>'
                                            +'</tr>'                           
                        });
                        $("#Audit").children().remove();
                        $("#Audit").append(MeetingRoomList);

                        if(Math.ceil(data.count/pageSize) == 0) {
                            pageNum = 0;
                        }
                        $("#current-page").val(pageNum);
                        $("#page-count").html(Math.ceil(data.count/pageSize));
                        checkDisable();
                    } 
                });
            }

            //补零
             function Appendzero (obj) {
                if (obj < 10) return "0" + obj; else return obj;
             }
              
            //时间戳格式化成正式时间可是
            function formatDate(now){    
                var time = new Date(now);
                var ymdhis = "";
                ymdhis += time.getFullYear() + "-";
                ymdhis += Appendzero((time.getMonth()+1)) + "-";
                ymdhis += Appendzero(time.getDate());
                ymdhis += " " + Appendzero(time.getHours()) + ":";
                ymdhis += Appendzero(time.getMinutes()) + ":";
                ymdhis += Appendzero(time.getSeconds());
                return ymdhis;
             }

            //将日期格式转化为时间戳
            function getTimeToUnit(sTimeTmp) {
                var ss = new Date(Date.parse(sTimeTmp.replace(/-/g, "/")));
                var sss = new Date(ss);
                var time_str = ss.getTime().toString();
                //var sTime =  time_str.substr(0, 10);
                return time_str;
            }

            function selectUser() {
                var paramJSon = {
                    "IS_PUBLIC": {
                        "FLOWNO": "",
                        "PERNR": "",
                        "ZDOMAIN": "400",
                        "I_PAGENO": "",
                        "I_PAGESIZE": ""
                    },
                    "P_DATE": "",
                    "P_PERNR": {
                        "item": [{
                            "PERNR": localStorage["pernrBase"]
                        }]
                    }
                };

                var userName = '';
                $.post("/zhr/ZHR_GET_PER_EASY_INFO", JSON.stringify(paramJSon), function (data) {
                    data = typeof(data) == 'string' ? $.parseJSON(data) : data;
                    if (data.RETURN_SUBRC == 0) {
                        userName = data.EASY_TAB.item[0]['NACHN'];
                    }
                });
                return userName;
            }
		</script>

		<link rel="stylesheet" href="../assets/css/ace.onpage-help.css" />
		<link rel="stylesheet" href="../docs/assets/js/themes/sunburst.css" />

		<script type="text/javascript"> ace.vars['base'] = '..'; </script>
		<script src="../assets/js/ace/ace.onpage-help.js"></script>
		<script src="../docs/assets/js/rainbow.js"></script>
		<script src="../docs/assets/js/language/generic.js"></script>
		<script src="../docs/assets/js/language/html.js"></script>
		<script src="../docs/assets/js/language/css.js"></script>
		<script src="../docs/assets/js/language/javascript.js"></script>
	</body>
</html>
